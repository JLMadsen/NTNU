import pyshark
from collections import defaultdict
import sys

# len=22 packet
# sample: 00120005d494478c0b0001063100037a6f806981a67e
#         __________________||______||________________
#         incrementing slow  tick?    data, probs pos
#         maybe packet id    userId?  4usr*2byte* x,y
#         

GAME_IP = '146.0.228.179'
players = 4

try:
    packets = pyshark.FileCapture('amongUsGame.pcapng', display_filter="udp")

    for packet in packets:
        try:
            if packet['ip'].dst == GAME_IP or packet['ip'].src == GAME_IP:
                data = packet.data.data
                #print('Data:', data)
                
                if len(data) == 44:
                    #print(data)
                    
                    data = str(data)
                    info, tick, = data[-(players*2*2):], data[-24:-18]
                    
                    info = [str(info[i: i+2]) for i in range(0, len(info), 2)]
                    print(tick, info)

                    for i in range(0, len(info), 2):
                        print('player', i+1)
                        print('x:', float(info[i]))
                        print('y:', float(info[i+1]))
                    
        except:
            # packet probably doesnt have ip layer
            # or data.data
            # or my code crashes
            pass
        
except:
    # outer loop shouldnt crash 
    # if you manage to read filecapture or livecapture
    pass
finally:
    packets.close()


def manual():
    pos = [[0x8748307a, 0xa5588464],
        [0x1c49c375, 0x1c966555],
        [0x1a97ec82, 0xc687e081],
        [0x1b4e537c, 0x3b68c37e]]

    ids = [0x0f1c,
        0x0f1d,
        0x091f,
        0x0f1b]

    for id, p in zip(ids, pos):
        print(id)
        print('x', int(p[0]) )
        print('y', int(p[1]) )
        print()
    